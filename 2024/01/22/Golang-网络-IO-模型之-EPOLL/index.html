<!DOCTYPE html>
<html lang="zh">
  <head>
    

    
<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>
    

<meta charset="utf-8" >

<title>Golang 网络 IO 模型之 EPOLL</title>
<meta name="keywords" content="Golang 网络 IO 模型之 EPOLL, HeXu">
<meta name="description" content="0 前言本文大抵分为两部分：第一部分聊 epoll 的实现原理（第一、二章）；第二部分串联 Golang 底层 IO 模型实现链路（第三章），观察其中对 epoll 技术的应用.
1 IO 多路复用1.1 何为 IO 多路复用首先拆解多路复">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:title" content="Golang 网络 IO 模型之 EPOLL">
<meta property="og:description" content="0 前言本文大抵分为两部分：第一部分聊 epoll 的实现原理（第一、二章）；第二部分串联 Golang 底层 IO 模型实现链路（第三章），观察其中对 epoll 技术的应用.
1 IO 多路复用1.1 何为 IO 多路复用首先拆解多路复">

<link rel="shortcut icon" href="/source/images/favicon.ico">
<link rel="stylesheet" href="/style/main.css">

  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://heexu976.github.io">
        <img class="avatar" src="/images/avatar.png" alt="logo" width="32px" height="32px">
      </a>
      <a href="https://heexu976.github.io">
        <h1 class="site-title">HeXu</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/" class="menu purple-link">
        首页
      </a>
    
  
    
      <a href="/tags" class="menu purple-link">
        标签
      </a>
    
  
    
      <a href="/archives" class="menu purple-link">
        归档
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        关于
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">Golang 网络 IO 模型之 EPOLL</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2024-01-22</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/tags/Golang/">
              Golang
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0 前言"></a>0 前言</h1><p>本文大抵分为两部分：第一部分聊 epoll 的实现原理（第一、二章）；第二部分串联 Golang 底层 IO 模型实现链路（第三章），观察其中对 epoll 技术的应用.</p>
<h1 id="1-IO-多路复用"><a href="#1-IO-多路复用" class="headerlink" title="1 IO 多路复用"></a>1 IO 多路复用</h1><h2 id="1-1-何为-IO-多路复用"><a href="#1-1-何为-IO-多路复用" class="headerlink" title="1.1 何为 IO 多路复用"></a>1.1 何为 IO 多路复用</h2><p>首先拆解多路复用一词：</p>
<ul>
<li>多路：存在多个待服务的对象</li>
<li>复用：只由一个执行单元提供服务</li>
</ul>
<p>串联上述要点，多路复用指的是，由<strong>一个执行单元</strong>，<strong>同时对多个对象提供服务</strong>，形成一对多的服务关系.</p>
<p>在 Linux 操作系统中，对 IO 多路复用的概念有着更加明确的定义：</p>
<ul>
<li><code>多路</code>：存在多个需要处理 <code>io event</code> 的 <code>fd</code>（Linux 中，一切皆文件，所有事务均可抽象为一个文件句柄 <code>file descriptor</code>，简称 <code>fd</code>）</li>
<li><code>复用</code>：复用一个 <code>loop thread</code> 同时为多个 <code>fd</code> 提供处理服务（线程 <code>thread</code> 是内核视角下的最小调度单位；多路复用通常为循环模型 <code>loop model</code>，因此称为 <code>loop thread</code>）</li>
</ul>
<h2 id="1-2-IO-多路复用的简单实现"><a href="#1-2-IO-多路复用的简单实现" class="headerlink" title="1.2 IO 多路复用的简单实现"></a>1.2 IO 多路复用的简单实现</h2><h3 id="1-阻塞-IO"><a href="#1-阻塞-IO" class="headerlink" title="1. 阻塞 IO"></a>1. 阻塞 IO</h3><p>下面通过一段伪代码，来尝试让 IO 多路复用这个概念看起来更加具体一些：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 多个待服务的 fd 
fds &#x3D; [fd1,fd2,fd3,...]
&#x2F;&#x2F; 遍历 fd 列表，末尾和首部相连，形成循环
i &#x3D; 0
for &#123;
    &#x2F;&#x2F; 获取本轮待处理的 fd
    fd &#x3D; fds[i]        
    &#x2F;&#x2F; 从 fd 中读数据
    data &#x3D; read(fd)  
    &#x2F;&#x2F; 处理数据 
    handle(data)             
    &#x2F;&#x2F; 推进遍历
    i++
    if i &#x3D;&#x3D; len(fds)&#123;
        i &#x3D; 0
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述搭了个架子，核心分为几步：</p>
<ul>
<li>定义了待处理的 fds 列表（多路）</li>
<li>循环遍历 fds 列表，每轮负责读一个 fd（复用）</li>
</ul>
<p>这是个乞丐版的 IO 多路复用模型看起来似乎有那么点意思了. 然而其本质上是一种阻塞 IO 模型 <strong>（Blocking IO，简称 BIO）</strong>. 事实上，上述实现存在一个致命的问题，那就是句柄 fd 默认的 io 操作是阻塞型的，因此倘若在读 fd1 的时候，io event 没到达，那么 loop thread 就会陷入阻塞，后续 fd2、fd3 哪怕有 io event 到达，也无法得到执行.</p>
<h3 id="2-非阻塞-IO"><a href="#2-非阻塞-IO" class="headerlink" title="2. 非阻塞 IO"></a>2. 非阻塞 IO</h3><p>基于 BIO 存在的问题，我们进行一轮改进，核心是将 read 操作由同步阻塞操作改为带有尝试性的<strong>非阻塞操作</strong>. 在读一个 fd 的时候，倘若 io event 已就绪就正常读取，否则就即时返回并抛出一个特定类型的错误，让 loop thread 能够正常执行下去，为其他 fd 提供服务.</p>
<pre class="line-numbers language-none"><code class="language-none"> fds &#x3D; [fd1,fd2,fd3,...]

&#x2F;&#x2F; 遍历 fd 列表，末尾和首部相连，形成循环
i &#x3D; 0
for &#123;
    &#x2F;&#x2F; 获取本轮待处理的 fd
    fd &#x3D; fds[i]        
    &#x2F;&#x2F; 尝试从 fd 中读数据，失败时不阻塞，而是抛出错误
    data,err &#x3D; tryRead(fd)  
    &#x2F;&#x2F; 读取数据成功，处理数据
    if err &#x3D;&#x3D; nil&#123;
        handle(data) 
    &#125; 
    &#x2F;&#x2F; 小睡一秒后再推进流程
    sleep(1 second)
    &#x2F;&#x2F; 推进遍历
    i++
    if i &#x3D;&#x3D; len(fds)&#123;
        i &#x3D; 0
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述伪代码核心步骤如下：</p>
<ul>
<li>定义了待处理的 fds 列表</li>
<li>遍历 fds 列表，每轮尝试从一个 fd 中读数据</li>
<li>倘若 io event 已就绪，则正常处理结果</li>
<li>倘若 io event 未就绪，只抛出错误，同样不阻塞流程</li>
<li>小睡一会儿，然后继续推进流程</li>
</ul>
<p>这里确实解决阻塞 IO 中的问题，其本质上是一种<strong>非阻塞 IO 模型（Nonblocking IO，简称 NIO</strong>）. 但这里仍然存在问题，就是每轮处理之间的休眠时间. 倘若在休眠期间，fd 中有 io event 到达，就无法被正常处理，这同样是一种不好的体验.</p>
<h2 id="1-3-IO-多路复用的优雅实现"><a href="#1-3-IO-多路复用的优雅实现" class="headerlink" title="1.3 IO 多路复用的优雅实现"></a>1.3 IO 多路复用的优雅实现</h2><p>linux 内核提供了三种经典的多路复用技术：</p>
<blockquote>
<ul>
<li>select</li>
<li>poll</li>
<li>epoll</li>
</ul>
</blockquote>
<p><code>select</code> 最通用，但是相对粗糙；而 <code>epoll</code> 则最精致，在性能上也有着最优越的表现.</p>
<p><code>poll</code> 在 <code>select</code> 的基础之上做了改进，但治标不治本，优化得不够彻底. 我们核心还是来对比看看 <code>select</code> 和 <code>epoll</code> 之间的共性和差异：</p>
<h3 id="1-select"><a href="#1-select" class="headerlink" title="1. select"></a>1. select</h3><ul>
<li>一次可以处理多个 fd，体现多路. 但 fd 数量有限，最多 1024 个</li>
<li>loop thread 通过 select 将一组 fd 提交到内核做监听</li>
<li>当 fd 中无 io event 就绪时，loop thread 会陷入阻塞</li>
<li>每当这组 fd 中有 io event 到达时，内核会唤醒 loop thread</li>
<li>loop thread 无法精准感知到哪些 fd 就绪，需要遍历一轮 fd 列表，时间复杂度 O(N)</li>
<li>托付给内核的 fd 列表只具有一轮交互的时效. 新的轮次中，loop thread 需要重新将监听的 fd 列表再传递给内核一次</li>
</ul>
<h3 id="2-epoll"><a href="#2-epoll" class="headerlink" title="2. epoll"></a>2. epoll</h3><ul>
<li>每次处理的 fd 数量无上限</li>
<li>loop thread 通过 epoll_create 操作创建一个 epoll 池子</li>
<li>loop thread 通过 epoll_ctl 每次将一个待监听的 fd 添加到 epoll 池中</li>
<li>每当 fd 列表中有 fd 就绪事件到达时，会唤醒 loop thread. 同时内核会将处于就绪态的 fd 直接告知 loop thread，无需额外遍历</li>
</ul>
<p>综上所述，select 和 epoll 等多路复用操作利用了内核的能力，能在待监听 fd 中有 io event 到达时，将 loop thread 唤醒，避免无意义的主动轮询操作.</p>
<p>其中，epoll 相比于 select 的核心性能优势在于：</p>
<ul>
<li>loop thread 被唤醒时，能明确知道哪些 fd 需要处理，减少了一次额外遍历的操作，时间复杂度由 O(N) 优化到 O(1)；</li>
<li>epoll 通过将创建池子和添加 fd 两个操作解耦，实现了池中 fd 数据的复用，减少了用户态与内核态间的数据拷贝成本。</li>
</ul>
<h1 id="2-EventPoll-原理"><a href="#2-EventPoll-原理" class="headerlink" title="2 EventPoll 原理"></a>2 EventPoll 原理</h1><h2 id="2-1-核心原理"><a href="#2-1-核心原理" class="headerlink" title="2.1 核心原理"></a>2.1 核心原理</h2><p>epoll 又称 EventPoll，使用很简单，包含三个指令：</p>
<ul>
<li>epoll_create</li>
<li>epoll_ctl</li>
<li>epoll_wait</li>
</ul>
<h3 id="1-epoll-create"><a href="#1-epoll-create" class="headerlink" title="1. epoll_create"></a>1. epoll_create</h3><p>在内核开辟空间，创建一个 epoll 池子用于批量存储管理 fd，后续可以通过 epoll_ctl 往池子中增删改 fd.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">epollcreate1</span><span class="token punctuation">(</span>flags <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token builtin">int32</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="2-epoll-ctl"><a href="#2-epoll-ctl" class="headerlink" title="2. epoll_ctl"></a>2. epoll_ctl</h3><p>在某个 <code>epoll</code> 池子中进行一个 fd 的增删改操作.</p>
<p>正是由于 <code>epoll</code> 中将 <code>epoll_ctl</code> 与 <code>epoll_create</code> 操作进行了解耦，才实现了对 <code>epoll_create</code> 时传递的 fd 数据的复用，<strong>减少了用户态和内核台之间对 fd 数据的重复传递</strong></p>
<p>此外，在 epoll_ctl 实现时，也需要通过 epollevent 设置好回调事件，当 fd 有指定事件到达时，会被添加到就绪队列中，最终将 loop thread 唤醒.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> op<span class="token punctuation">,</span> fd <span class="token builtin">int32</span><span class="token punctuation">,</span> ev <span class="token operator">*</span>epollevent<span class="token punctuation">)</span> <span class="token builtin">int32</span>


<span class="token keyword">type</span> epollevent <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    events <span class="token builtin">uint32</span>
    data   <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token comment">// unaligned uintptr</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-epoll-wait"><a href="#3-epoll-wait" class="headerlink" title="3. epoll_wait"></a>3. epoll_wait</h3><p>从对应 epoll 池子中获取就绪的 epollevent，从中可以关联到对应的 fd 和 loop thread 信息.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">epollwait</span><span class="token punctuation">(</span>epfd <span class="token builtin">int32</span><span class="token punctuation">,</span> ev <span class="token operator">*</span>epollevent<span class="token punctuation">,</span> nev<span class="token punctuation">,</span> timeout <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token builtin">int32</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="2-2-核心数据结构"><a href="#2-2-核心数据结构" class="headerlink" title="2.2 核心数据结构"></a>2.2 核心数据结构</h2><h3 id="1-epoll-池红黑树"><a href="#1-epoll-池红黑树" class="headerlink" title="1. epoll 池红黑树"></a>1. epoll 池红黑树</h3><p>一个 epoll 池子中管理的 fd 数量理论上上不封顶. 同时后续可能存在对 fd 的增删改操作，因此需要使用合适的数据结构加以管理，从而降低后续操作的时间复杂度.</p>
<p>linux 内核中，实现 <code>epoll</code> 池的数据结构采用的是红黑树（<code>Red-Black Tree</code>，一种自平衡二叉查找树，这里不作展开，感兴趣自行了解）实现，保证了所有增、删、改操作的平均时间复杂度维持在 <strong>O(logN)</strong> 的对数级水平.</p>
<h3 id="2-就绪时间队列"><a href="#2-就绪时间队列" class="headerlink" title="2. 就绪时间队列"></a>2. 就绪时间队列</h3><p>针对于 fd 的就绪 <code>io event</code>，由于通常数量有限，且每个事件都需要逐一处理，没有优先级之分，因此采用简单的<strong>双向链表</strong>实现即可.</p>
<h2 id="2-3-事件回调机制"><a href="#2-3-事件回调机制" class="headerlink" title="2.3 事件回调机制"></a>2.3 事件回调机制</h2><p>epoll <strong>高效的核心建立在精准的事件回调机制</strong>之上.</p>
<p>首先，通过内核感知到 io event 事件的动态，令 loop thread 在合适的时机阻塞，避免浪费 CPU；在合适的时机执行，及时处理 io event.</p>
<p>其次，在 io event 就绪时，会精准地将真正就绪的 fd 传递到 loop thread 手中，减少了一次无意义的遍历查询动作.</p>
<p>事件回调的注册是在调用 epoll_ctl 添加 fd 时，此时会提前设置好对这个 fd 关心的事件类型，当对应的 io event 真的发生时，内核会将该 fd 和对应的 loop thread 封装到 epollevent 中，添加到就绪队列 ready list 当中.</p>
<h1 id="3-Golang-网络-IO-源码走读"><a href="#3-Golang-网络-IO-源码走读" class="headerlink" title="3 Golang 网络 IO 源码走读"></a>3 Golang 网络 IO 源码走读</h1><h2 id="3-1-启动-TCP-服务器"><a href="#3-1-启动-TCP-服务器" class="headerlink" title="3.1 启动 TCP 服务器"></a>3.1 启动 TCP 服务器</h2><p>首先给出一个启动 tcp 服务的代码框架，伪代码如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 启动一个 tcp 服务端代码示例</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
   <span class="token comment">// 创建一个 tcp 端口监听器</span>
   l<span class="token punctuation">,</span><span class="token boolean">_</span> <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
   <span class="token comment">// 主动轮询模型</span>
   <span class="token keyword">for</span><span class="token punctuation">&#123;</span>
       <span class="token comment">// 等待 tcp 连接到达</span>
       conn<span class="token punctuation">,</span><span class="token boolean">_</span> <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     
       <span class="token comment">// 开启一个 goroutine 负责一笔客户端请求的处理</span>
       <span class="token keyword">go</span> <span class="token function">serve</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 处理一笔 tcp 连接</span>
<span class="token keyword">func</span> <span class="token function">serve</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> buf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token comment">// 读取连接中的数据</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span><span class="token boolean">_</span> <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>    
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>方法核心步骤都展示于 <code>main</code> 函数中了：</p>
<ul>
<li>创建了一个 tcp 端口监听器 <code>listener</code></li>
<li>通过 for 循环建立主动轮询模型</li>
<li>每轮尝试从 <code>listener</code> 中获取到达的 tcp 连接</li>
<li>倘若成功取到连接，则 1:1启动一个 <code>goroutine</code> 异步处理连接的请求</li>
<li>倘若无连接到达，则阻塞主流程<br>其中，有两个方法是核心入口：一个是创建 <code>Listener</code> 的 <code>net.Listen</code>；另一个是从 <code>Listener</code> 获取连接的 <code>Listener.Accept</code> 方法.</li>
</ul>
<h2 id="3-2-启动-TCP-端口监听器"><a href="#3-2-启动-TCP-端口监听器" class="headerlink" title="3.2 启动 TCP 端口监听器"></a>3.2 启动 TCP 端口监听器</h2><h3 id="1-创建-Listener-前处理"><a href="#1-创建-Listener-前处理" class="headerlink" title="1. 创建 Listener 前处理"></a>1. 创建 Listener 前处理</h3><p>在创建 TCP 端口 <code>Listener</code> 时，首先历经 <code>Listen</code> -&gt; <code>ListenerConfig.Listen</code> -&gt; <code>sysListener.listenTCP</code> -&gt; <code>internetSocket</code> -&gt; <code>socket</code> 方法的辗转，最终来到位于 <code>runtime/sock_posix.go</code> 的 <code>socket</code> 方法中，开始执行套接字 <code>socket</code> 的创建和初始化.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Listen</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Listener<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> lc ListenConfig
    <span class="token keyword">return</span> lc<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> network<span class="token punctuation">,</span> address<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lc <span class="token operator">*</span>ListenConfig<span class="token punctuation">)</span> <span class="token function">Listen</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Listener<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">var</span> l Listener
    la <span class="token operator">:=</span> addrs<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span>isIPv4<span class="token punctuation">)</span>
    <span class="token keyword">switch</span> la <span class="token operator">:=</span> la<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>TCPAddr<span class="token punctuation">:</span>
        l<span class="token punctuation">,</span> err <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">listenTCP</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> la<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sl <span class="token operator">*</span>sysListener<span class="token punctuation">)</span> <span class="token function">listenTCP</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> laddr <span class="token operator">*</span>TCPAddr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>TCPListener<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">internetSocket</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sl<span class="token punctuation">.</span>network<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"listen"</span><span class="token punctuation">,</span> sl<span class="token punctuation">.</span>ListenConfig<span class="token punctuation">.</span>Control<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">internetSocket</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> net <span class="token builtin">string</span><span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr sockaddr<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto <span class="token builtin">int</span><span class="token punctuation">,</span> mode <span class="token builtin">string</span><span class="token punctuation">,</span> ctrlFn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>RawConn<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token function">socket</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> net<span class="token punctuation">,</span> family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto<span class="token punctuation">,</span> ipv6only<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr<span class="token punctuation">,</span> ctrlFn<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-创建-socket"><a href="#2-创建-socket" class="headerlink" title="2.创建 socket"></a>2.创建 socket</h3><p>在 <code>socket</code> 方法中首先，在 <code>sysSocket</code> 方法中，发起两次系统调用：</p>
<ul>
<li><code>syscall.Socket</code> 创建套接字</li>
<li><code>syscall.SetNonblock</code> 将 <code>socket</code> 设置为非阻塞模式</li>
</ul>
<p>然后步入 <code>netFD.listenStream</code> 方法，将 <code>socket fd</code> 和端口进行绑定和监听，然后调用 <code>epoll</code> 指令<strong>设定 io 多路复用模式</strong>.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">socket</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> net <span class="token builtin">string</span><span class="token punctuation">,</span> family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto <span class="token builtin">int</span><span class="token punctuation">,</span> ipv6only <span class="token builtin">bool</span><span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr sockaddr<span class="token punctuation">,</span> ctrlFn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>RawConn<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建一个 socket 套接字</span>
    s<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">sysSocket</span><span class="token punctuation">(</span>family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto<span class="token punctuation">)</span>   
    <span class="token comment">// ...</span>
    <span class="token comment">// 绑定、监听端口，并对 socket fd 进行初始化. epoll_create 和 epoll_ctl 执行的执行正是在初始化的流程中.</span>
    fd<span class="token punctuation">.</span><span class="token function">listenStream</span><span class="token punctuation">(</span>laddr<span class="token punctuation">,</span> <span class="token function">listenerBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctrlFn<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// socketFunc 宏指令，关联执行系统调用 syscall.Socket 创建套接字</span>
<span class="token keyword">var</span> socketFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>  <span class="token operator">=</span> syscall<span class="token punctuation">.</span>Socket


<span class="token keyword">func</span> <span class="token function">sysSocket</span><span class="token punctuation">(</span>family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 通过系统调用创建一个 socket</span>
    s<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">socketFunc</span><span class="token punctuation">(</span>family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto<span class="token punctuation">)</span>
    <span class="token comment">// 通过系统调用将 socket 设置为非阻塞模式</span>
    syscall<span class="token punctuation">.</span><span class="token function">SetNonblock</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-绑定、窗口"><a href="#3-绑定、窗口" class="headerlink" title="3.绑定、窗口"></a>3.绑定、窗口</h3><p>在 <code>netFD.listenStream</code> 方法中</p>
<ul>
<li>发起系统调用 <code>syscall.Bind</code> 实现 <code>socket fd</code> 和端口的绑定</li>
<li>发起系统调用，实现对 <code>fd</code> 的监听</li>
<li>调用 <code>netFD.init</code> 方法对 <code>socket fd</code> 进行初始化</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// listenFunc 宏指令，关联执行系统调用 syscall.Listen 监听端口</span>
<span class="token keyword">var</span> listenFunc        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span>              <span class="token operator">=</span> syscall<span class="token punctuation">.</span>Listen


<span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">)</span> <span class="token function">listenStream</span><span class="token punctuation">(</span>laddr sockaddr<span class="token punctuation">,</span> backlog <span class="token builtin">int</span><span class="token punctuation">,</span> ctrlFn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>RawConn<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 调用 bind 系统调用，将 socket fd 和端口进行绑定</span>
    syscall<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> lsa<span class="token punctuation">)</span>
    <span class="token comment">// 通过宏指令调用 listen 系统调</span>
    <span class="token function">listenFunc</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> backlog<span class="token punctuation">)</span>
    <span class="token comment">// 初始化 socket fd，在其中执行了 epoll 操作</span>
    fd<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>net<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>FD<span class="token punctuation">)</span> <span class="token function">Init</span><span class="token punctuation">(</span>net <span class="token builtin">string</span><span class="token punctuation">,</span> pollable <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-创建-epoll-池"><a href="#4-创建-epoll-池" class="headerlink" title="4. 创建 epoll 池"></a>4. 创建 epoll 池</h3><p>从 <code>netFD.init</code> 方法出发，历经 <code>netFD.init</code> -&gt; <code>FD.Init</code> -&gt; <code>pollDesc.init</code> 的链路，最终在 <code>pollDesc.init</code> 方法中，通过 <code>sync.Once</code> 保证全局只执行一次 <code>runtime_pollServerInit</code> 方法作 epoll 池的初始化</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> serverInit sync<span class="token punctuation">.</span>Once


<span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span>fd <span class="token operator">*</span>FD<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    serverInit<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>runtime_pollServerInit<span class="token punctuation">)</span>
    ctx<span class="token punctuation">,</span> errno <span class="token operator">:=</span> <span class="token function">runtime_pollOpen</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>runtime_pollServerInit</code> 方法最终会编译关联到位于 <code>runtime/netpoll_epoll.go</code> 文件的 <code>netpollinit</code> 方法，可以看到在方法中，通过调用 <code>epollcreate1</code> 方法，执行了 <code>epoll</code> 指令完成了 epoll 池的创建.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpollinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 执行 epoll_create 执行，开辟一块 epoll 池</span>
    epfd <span class="token operator">=</span> <span class="token function">epollcreate1</span><span class="token punctuation">(</span>_EPOLL_CLOEXEC<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-socket-fd-入池"><a href="#5-socket-fd-入池" class="headerlink" title="5. socket fd 入池"></a>5. socket fd 入池</h3><p>在 <code>pollDesc.init</code> 方法确保全局完成一次 epoll 池的创建后，会调用 <code>runtime_pollOpen</code> 方法将当前 fd 添加到 epoll 池中.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> serverInit sync<span class="token punctuation">.</span>Once


<span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span>fd <span class="token operator">*</span>FD<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    serverInit<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>runtime_pollServerInit<span class="token punctuation">)</span>
    ctx<span class="token punctuation">,</span> errno <span class="token operator">:=</span> <span class="token function">runtime_pollOpen</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>runtime_pollOpen 方法最终会编译关联到位于 runtime&#x2F;netpoll_epoll.go 文件的 netpollopen 方法，其中会调用 epollctl 指令，完成 socket fd 的入池操作.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpollopen</span><span class="token punctuation">(</span>fd <span class="token builtin">uintptr</span><span class="token punctuation">,</span> pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token builtin">int32</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 将待监听的 socket fd 添加到 epoll 池中，并注册好回调路径</span>
    <span class="token keyword">var</span> ev epollevent
    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> _EPOLLIN <span class="token operator">|</span> _EPOLLOUT <span class="token operator">|</span> _EPOLLRDHUP <span class="token operator">|</span> _EPOLLET
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pollDesc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> pd    
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> _EPOLL_CTL_ADD<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-3-获取-TCP-链接"><a href="#3-3-获取-TCP-链接" class="headerlink" title="3.3 获取 TCP 链接"></a>3.3 获取 TCP 链接</h2><h3 id="1-获取-TCP-前处理"><a href="#1-获取-TCP-前处理" class="headerlink" title="1. 获取 TCP 前处理"></a>1. 获取 TCP 前处理</h3><p>在创建好 <code>Listener</code> 后，接下来调用 <code>Listener.Accept</code> 方法，可以实现有 tcp 连接就绪时会取得连接；<strong>无 tcp 连接时令当前 goroutine 陷入阻塞的效果.</strong></p>
<p>历经 <code>TCPListener.Accept</code> -&gt; <code>TCPListener.accept</code> -&gt; <code>netFD.accept</code> -&gt; <code>FD.Accept</code> 的辗转，最终获取 tcp 连接及阻塞处理的核心逻辑实现于 <code>internal/poll/fd_unix.go</code> 的 <code>FD.Accept</code> 方法.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>TCPListener<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    c<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ln <span class="token operator">*</span>TCPListener<span class="token punctuation">)</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>TCPConn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> ln<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">)</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>netfd <span class="token operator">*</span>netFD<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 倘若有 tcp 连接到达，则成功取出并返回</span>
    <span class="token comment">// 倘若没有 tcp 连接到达，会 gopark 进入被动阻塞，等待被唤醒</span>
    d<span class="token punctuation">,</span> rsa<span class="token punctuation">,</span> errcall<span class="token punctuation">,</span> err <span class="token operator">:=</span> fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-尝试获取-TCP-链接"><a href="#2-尝试获取-TCP-链接" class="headerlink" title="2. 尝试获取 TCP 链接"></a>2. 尝试获取 TCP 链接</h3><p>在 <code>FD.Accept </code>方法中：</p>
<ul>
<li>首先调用 <code>accept</code> 方法，会通过系统调用 <code>syscall.Accept</code> 以非阻塞模式尝试获取一次对应 socket fd 下到达的 tcp 连接</li>
<li>倘若没有就绪的 tcp 连接，会抛出 <code>syscall.EAGAIN</code> 错误，此时会走入 <code>pollDesc.waitRead</code> 分支，最终通过 <code>gopark</code> 操作令当前 <code>goroutine</code> 陷入被动阻塞状态</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>FD<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>Sockaddr<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 通过 accept 系统调用，尝试接收一个连接</span>
        s<span class="token punctuation">,</span> rsa<span class="token punctuation">,</span> errcall<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">accept</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">)</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">switch</span> err <span class="token punctuation">&#123;</span>    
        <span class="token keyword">case</span> syscall<span class="token punctuation">.</span>EAGAIN<span class="token punctuation">:</span>
            <span class="token keyword">if</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">pollable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> err <span class="token operator">=</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">waitRead</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>isFile<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token comment">// ...</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> AcceptFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>Sockaddr<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token operator">=</span> syscall<span class="token punctuation">.</span>Accept

<span class="token keyword">func</span> <span class="token function">accept</span><span class="token punctuation">(</span>s <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>Sockaddr<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    ns<span class="token punctuation">,</span> sa<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">AcceptFunc</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">waitRead</span><span class="token punctuation">(</span>isFile <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token char">'r'</span><span class="token punctuation">,</span> isFile<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">wait</span><span class="token punctuation">(</span>mode <span class="token builtin">int</span><span class="token punctuation">,</span> isFile <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    res <span class="token operator">:=</span> <span class="token function">runtime_pollWait</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>runtimeCtx<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-被动阻塞-goroutine"><a href="#3-被动阻塞-goroutine" class="headerlink" title="3. 被动阻塞 goroutine"></a>3. 被动阻塞 goroutine</h3><p>历经 <code>pollDesc.waitRead</code> -&gt; <code>pollDesc.wait</code> -&gt; <code>poll_runtime_pollWait</code> 的链路，最终会在 <code>netpollblock</code> 方法中，通过 <code>gopark</code> 操作，令求 tcp 连接而不得的 <code>loop goroutine</code> 陷入被动阻塞状态.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">poll_runtime_pollWait</span><span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">for</span> <span class="token operator">!</span><span class="token function">netpollblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpollblock</span><span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int32</span><span class="token punctuation">,</span> waitio <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> waitio <span class="token operator">||</span> <span class="token function">netpollcheckerr</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token operator">==</span> pollNoError <span class="token punctuation">&#123;</span>
        <span class="token comment">// 调用 gopark 被动阻塞挂起</span>
        <span class="token function">gopark</span><span class="token punctuation">(</span>netpollblockcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gpp<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonIOWait<span class="token punctuation">,</span> traceEvGoBlockNet<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-4-TCP-链接读数据"><a href="#3-4-TCP-链接读数据" class="headerlink" title="3.4 TCP 链接读数据"></a>3.4 TCP 链接读数据</h2><h3 id="1-conn-fd-入池"><a href="#1-conn-fd-入池" class="headerlink" title="1. conn fd 入池"></a>1. conn fd 入池</h3><p>在位于 <code>internal/poll/sock_cloexec.go</code> 的 <code>netFD.accept</code> 方法中，倘若通过系统调用 <code>syscall.Accept</code> 成功获取到了到达的 tcp 连接，则会将其封装为一个 <code>netFD</code>，并通过 <code>epoll_ctl</code> 指令将该 fd 添加到 epoll 池中，实现对 read 事件的监听.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">)</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>netfd <span class="token operator">*</span>netFD<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 调用 accept 系统调用，接收 tcp 连接</span>
    d<span class="token punctuation">,</span> rsa<span class="token punctuation">,</span> errcall<span class="token punctuation">,</span> err <span class="token operator">:=</span> fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 将 connet fd 封装成 netfd</span>
    netfd<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">newFD</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>family<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>sotype<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>net<span class="token punctuation">)</span>
    <span class="token comment">// 对 netfd 进行初始化，底层会调用 epoll_ctl 将其注册到 listener 对应的 epoll 池中 </span>
    netfd<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>net<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>FD<span class="token punctuation">)</span> <span class="token function">Init</span><span class="token punctuation">(</span>net <span class="token builtin">string</span><span class="token punctuation">,</span> pollable <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">// ...</span>
    err <span class="token operator">:=</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span>fd <span class="token operator">*</span>FD<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    serverInit<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>runtime_pollServerInit<span class="token punctuation">)</span>
    ctx<span class="token punctuation">,</span> errno <span class="token operator">:=</span> <span class="token function">runtime_pollOpen</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>获取到 tcp 连接后，在缓存区数据未就绪时，用户执行 read 操作同样会陷入阻塞，对应的方法链路如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    n<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> n<span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    n<span class="token punctuation">,</span> err <span class="token operator">=</span> fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-读-TCP-数据"><a href="#2-读-TCP-数据" class="headerlink" title="2. 读 TCP 数据"></a>2. 读 TCP 数据</h3><p>在位于 <code>internal/poll/fd_unix.go</code> 的 <code>FD.Read</code> 方法中，会执行 <code>syscall.Read</code> 尝试从 <code>conn fd</code> 中读取数据，倘若数据未就绪，则会抛出 <code>EAGAIN error</code>，此时会调用 <code>pollDesc.waitRead</code> 方法将当前的 <code>loop read goroutine</code> 挂起，链路同 3.3 小节第（2）部分，不再赘述.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>FD<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
        n<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ignoringEINTRIO</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>Read<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> err <span class="token operator">==</span> syscall<span class="token punctuation">.</span>EAGAIN <span class="token operator">&amp;&amp;</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">pollable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">waitRead</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>isFile<span class="token punctuation">)</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">waitRead</span><span class="token punctuation">(</span>isFile <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token char">'r'</span><span class="token punctuation">,</span> isFile<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">wait</span><span class="token punctuation">(</span>mode <span class="token builtin">int</span><span class="token punctuation">,</span> isFile <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    res <span class="token operator">:=</span> <span class="token function">runtime_pollWait</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>runtimeCtx<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">poll_runtime_pollWait</span><span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">for</span> <span class="token operator">!</span><span class="token function">netpollblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpollblock</span><span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int32</span><span class="token punctuation">,</span> waitio <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> waitio <span class="token operator">||</span> <span class="token function">netpollcheckerr</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token operator">==</span> pollNoError <span class="token punctuation">&#123;</span>
        <span class="token comment">// 调用 gopark 被动阻塞挂起</span>
        <span class="token function">gopark</span><span class="token punctuation">(</span>netpollblockcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gpp<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonIOWait<span class="token punctuation">,</span> traceEvGoBlockNet<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-写-TCP-数据"><a href="#3-写-TCP-数据" class="headerlink" title="3. 写 TCP 数据"></a>3. 写 TCP 数据</h3><p>向 tcp 连接中写入数据的流程基本和 3.4 小节第（2）部分从 tcp 连接读取数据的链路形成对仗.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    n<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nn <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    nn<span class="token punctuation">,</span> err <span class="token operator">=</span> fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在位于 <code>internal/poll/fd_unix.go</code> 的 <code>FD.Write</code> 方法，会执行系统调用 <code>syscall.Write</code>，尝试将数据写入 tcp 连接的缓冲区. <strong>倘若当前缓冲区已经没有剩余的空间，则会抛出 EAGAIN 错误</strong>，然后执行 <code>pollDesc.waitWrite</code>，最终执行 <code>gopark</code> 操作将当前 <code>loop write goroutine</code> 挂起.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>FD<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">var</span> nn <span class="token builtin">int</span>
    <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
        max <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
        <span class="token comment">// ...</span>
        n<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ignoringEINTRIO</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>Write<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> p<span class="token punctuation">[</span>nn<span class="token punctuation">:</span>max<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">if</span> err <span class="token operator">==</span> syscall<span class="token punctuation">.</span>EAGAIN <span class="token operator">&amp;&amp;</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">pollable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">waitWrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>isFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">waitWrite</span><span class="token punctuation">(</span>isFile <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token char">'w'</span><span class="token punctuation">,</span> isFile<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">wait</span><span class="token punctuation">(</span>mode <span class="token builtin">int</span><span class="token punctuation">,</span> isFile <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    res <span class="token operator">:=</span> <span class="token function">runtime_pollWait</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>runtimeCtx<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpollblock</span><span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int32</span><span class="token punctuation">,</span> waitio <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> waitio <span class="token operator">||</span> <span class="token function">netpollcheckerr</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token operator">==</span> pollNoError <span class="token punctuation">&#123;</span>
        <span class="token comment">// 调用 gopark 被动阻塞挂起</span>
        <span class="token function">gopark</span><span class="token punctuation">(</span>netpollblockcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gpp<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonIOWait<span class="token punctuation">,</span> traceEvGoBlockNet<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-6-唤醒-IO-阻塞携程"><a href="#3-6-唤醒-IO-阻塞携程" class="headerlink" title="3.6 唤醒 IO 阻塞携程"></a>3.6 唤醒 IO 阻塞携程</h2><p>当 <code>io event</code> 未就绪时，会在位于 <code>runtime/netpoll.go</code> 的 <code>poll_runtime_pollWait</code> 方法中执行 <code>gopark</code> 操作，令当前的 <code>loop goroutine</code> 陷入被动阻塞状态.</p>
<p>本小节我们就来看看，这些 <code>goroutine</code> 将会在什么时机得到唤醒的机会.</p>
<h3 id="1-全局监控任务-sysmon"><a href="#1-全局监控任务-sysmon" class="headerlink" title="1. 全局监控任务 sysmon"></a>1. 全局监控任务 sysmon</h3><p>在位于 <code>runtime/proc.go</code> 的 main 函数中，会单独启动一个 <code>m（GMP中对线程的抽象 M）</code>，用于执行 <code>sysmon</code> 监控任务.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">newm</span><span class="token punctuation">(</span>sysmon<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  
    <span class="token comment">// ... </span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 <code>sysmon</code> 函数中，会每隔 10ms 调用 <code>netpoll</code> 函数，尝试取出 <code>io event</code> 已到达的 <code>loop goroutine</code>，进行唤醒操作.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">sysmon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>        
        <span class="token comment">// 每 10 ms 周期性执行一次</span>
        lastpoll <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lastpoll<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token function">netpollinited</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lastpoll <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lastpoll<span class="token operator">+</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">1000</span> <span class="token operator">&lt;</span> now <span class="token punctuation">&#123;</span>
            atomic<span class="token punctuation">.</span><span class="token function">Cas64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lastpoll<span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span>lastpoll<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 取出就绪的 loop goroutine</span>
            list <span class="token operator">:=</span> <span class="token function">netpoll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
            <span class="token comment">// ...</span>
            <span class="token comment">// 唤醒 list 中的 goruotine</span>
            <span class="token function">injectglist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>netpoll</code> 方法位于 <code>runtime/net_epoll.go</code> 文件，方法中会基于非阻塞模式调用 <code>epollwait</code> 方法，获取到就绪事件队列 <code>events</code>，然后遍历事件队列，调用 <code>netpollready</code> 方法将对应的 <code>loop goroutine</code> 添加到 <code>gList</code> 中返回给上层用于执行唤醒操作.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpoll</span><span class="token punctuation">(</span>delay <span class="token builtin">int64</span><span class="token punctuation">)</span> gList <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">var</span> events <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span>epollevent
retry<span class="token punctuation">:</span>
    <span class="token comment">// 非阻塞调用 epoll_wait，接收到就绪的事件列表</span>
    n <span class="token operator">:=</span> <span class="token function">epollwait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> waitms<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">var</span> toRun gList
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
        ev <span class="token operator">:=</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token comment">// 添加关心的事件模式</span>
        <span class="token keyword">var</span> mode <span class="token builtin">int32</span>
        <span class="token keyword">if</span> ev<span class="token punctuation">.</span>events<span class="token operator">&amp;</span><span class="token punctuation">(</span>_EPOLLIN<span class="token operator">|</span>_EPOLLRDHUP<span class="token operator">|</span>_EPOLLHUP<span class="token operator">|</span>_EPOLLERR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            mode <span class="token operator">+=</span> <span class="token char">'r'</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> ev<span class="token punctuation">.</span>events<span class="token operator">&amp;</span><span class="token punctuation">(</span>_EPOLLOUT<span class="token operator">|</span>_EPOLLHUP<span class="token operator">|</span>_EPOLLERR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            mode <span class="token operator">+=</span> <span class="token char">'w'</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 从 event 中获取已就绪的 fd，调用 netpollready 方法将 fd 添加到 gList 中用于返回，在上层进行唤醒和执行</span>
        <span class="token keyword">if</span> mode <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            pd <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pollDesc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            pd<span class="token punctuation">.</span><span class="token function">setEventErr</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>events <span class="token operator">==</span> _EPOLLERR<span class="token punctuation">)</span>
            <span class="token function">netpollready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>toRun<span class="token punctuation">,</span> pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> toRun
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpoll</span><span class="token punctuation">(</span>delay <span class="token builtin">int64</span><span class="token punctuation">)</span> gList <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">var</span> events <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span>epollevent
retry<span class="token punctuation">:</span>
    <span class="token comment">// 非阻塞调用 epoll_wait，接收到就绪的事件列表</span>
    n <span class="token operator">:=</span> <span class="token function">epollwait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> waitms<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">var</span> toRun gList
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
        ev <span class="token operator">:=</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token comment">// 添加关心的事件模式</span>
        <span class="token keyword">var</span> mode <span class="token builtin">int32</span>
        <span class="token keyword">if</span> ev<span class="token punctuation">.</span>events<span class="token operator">&amp;</span><span class="token punctuation">(</span>_EPOLLIN<span class="token operator">|</span>_EPOLLRDHUP<span class="token operator">|</span>_EPOLLHUP<span class="token operator">|</span>_EPOLLERR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            mode <span class="token operator">+=</span> <span class="token char">'r'</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> ev<span class="token punctuation">.</span>events<span class="token operator">&amp;</span><span class="token punctuation">(</span>_EPOLLOUT<span class="token operator">|</span>_EPOLLHUP<span class="token operator">|</span>_EPOLLERR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            mode <span class="token operator">+=</span> <span class="token char">'w'</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 从 event 中获取已就绪的 fd，调用 netpollready 方法将 fd 添加到 gList 中用于返回，在上层进行唤醒和执行</span>
        <span class="token keyword">if</span> mode <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            pd <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pollDesc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            pd<span class="token punctuation">.</span><span class="token function">setEventErr</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>events <span class="token operator">==</span> _EPOLLERR<span class="token punctuation">)</span>
            <span class="token function">netpollready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>toRun<span class="token punctuation">,</span> pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> toRun
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpollready</span><span class="token punctuation">(</span>toRun <span class="token operator">*</span>gList<span class="token punctuation">,</span> pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> rg<span class="token punctuation">,</span> wg <span class="token operator">*</span>g
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token char">'r'</span> <span class="token operator">||</span> mode <span class="token operator">==</span> <span class="token char">'r'</span><span class="token operator">+</span><span class="token char">'w'</span> <span class="token punctuation">&#123;</span>
        rg <span class="token operator">=</span> <span class="token function">netpollunblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token char">'r'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token char">'w'</span> <span class="token operator">||</span> mode <span class="token operator">==</span> <span class="token char">'r'</span><span class="token operator">+</span><span class="token char">'w'</span> <span class="token punctuation">&#123;</span>
        wg <span class="token operator">=</span> <span class="token function">netpollunblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token char">'w'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 将 read、write 的就绪 fd 对应的 goroutine 中，添加到 toRun 链表中</span>
    <span class="token keyword">if</span> rg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        toRun<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rg<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> wg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        toRun<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>wg<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-GMP-调度主流程"><a href="#2-GMP-调度主流程" class="headerlink" title="2. GMP 调度主流程"></a>2. GMP 调度主流程</h3><p>在 GMP 主流程方法 <code>schedule</code> 中，在每轮调度中，<code>g0</code> 都会调用 <code>findrunnable</code> 为当前 <code>P</code> 寻找下一个可执行的 <code>goroutine</code>. 此时当 <code>P</code> 本地队列和全局队列都没有待执行的 <code>goroutine</code> 时，则会尝试获取就绪的 <code>loop goroutine</code> 用于执行.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token function">netpollinited</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netpollWaiters<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lastpoll<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> list <span class="token operator">:=</span> <span class="token function">netpoll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// non-blocking</span>
            gp <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">injectglist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span>
            <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span>
            <span class="token comment">//... </span>
            <span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="3-GC-start-the-world"><a href="#3-GC-start-the-world" class="headerlink" title="3. GC start the world"></a>3. GC start the world</h3><p>在 GC 过程中，每次调用完 stop the world 之后，都会对仗调用 start the world 重启世界，此时也会对就绪的 loop goroutine 执行唤醒操作.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">startTheWorldWithSema</span><span class="token punctuation">(</span>emitTraceEvent <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token function">netpollinited</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        list <span class="token operator">:=</span> <span class="token function">netpoll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// non-blocking</span>
        <span class="token comment">// 唤醒 list 中的 goruotine</span>
        <span class="token function">injectglist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(end)</p>

        </div>
          
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#0-%E5%89%8D%E8%A8%80"><span class="top-box-text">0 前言</span></a></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#1-IO-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="top-box-text">1 IO 多路复用</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#1-1-%E4%BD%95%E4%B8%BA-IO-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="top-box-text">1.1 何为 IO 多路复用</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#1-2-IO-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="top-box-text">1.2 IO 多路复用的简单实现</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-%E9%98%BB%E5%A1%9E-IO"><span class="top-box-text">1. 阻塞 IO</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-%E9%9D%9E%E9%98%BB%E5%A1%9E-IO"><span class="top-box-text">2. 非阻塞 IO</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#1-3-IO-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E4%BC%98%E9%9B%85%E5%AE%9E%E7%8E%B0"><span class="top-box-text">1.3 IO 多路复用的优雅实现</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-select"><span class="top-box-text">1. select</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-epoll"><span class="top-box-text">2. epoll</span></a></li></ol></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#2-EventPoll-%E5%8E%9F%E7%90%86"><span class="top-box-text">2 EventPoll 原理</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#2-1-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="top-box-text">2.1 核心原理</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-epoll-create"><span class="top-box-text">1. epoll_create</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-epoll-ctl"><span class="top-box-text">2. epoll_ctl</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-epoll-wait"><span class="top-box-text">3. epoll_wait</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#2-2-%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="top-box-text">2.2 核心数据结构</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-epoll-%E6%B1%A0%E7%BA%A2%E9%BB%91%E6%A0%91"><span class="top-box-text">1. epoll 池红黑树</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-%E5%B0%B1%E7%BB%AA%E6%97%B6%E9%97%B4%E9%98%9F%E5%88%97"><span class="top-box-text">2. 就绪时间队列</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#2-3-%E4%BA%8B%E4%BB%B6%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6"><span class="top-box-text">2.3 事件回调机制</span></a></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#3-Golang-%E7%BD%91%E7%BB%9C-IO-%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB"><span class="top-box-text">3 Golang 网络 IO 源码走读</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#3-1-%E5%90%AF%E5%8A%A8-TCP-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="top-box-text">3.1 启动 TCP 服务器</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#3-2-%E5%90%AF%E5%8A%A8-TCP-%E7%AB%AF%E5%8F%A3%E7%9B%91%E5%90%AC%E5%99%A8"><span class="top-box-text">3.2 启动 TCP 端口监听器</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-%E5%88%9B%E5%BB%BA-Listener-%E5%89%8D%E5%A4%84%E7%90%86"><span class="top-box-text">1. 创建 Listener 前处理</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-%E5%88%9B%E5%BB%BA-socket"><span class="top-box-text">2.创建 socket</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-%E7%BB%91%E5%AE%9A%E3%80%81%E7%AA%97%E5%8F%A3"><span class="top-box-text">3.绑定、窗口</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#4-%E5%88%9B%E5%BB%BA-epoll-%E6%B1%A0"><span class="top-box-text">4. 创建 epoll 池</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#5-socket-fd-%E5%85%A5%E6%B1%A0"><span class="top-box-text">5. socket fd 入池</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#3-3-%E8%8E%B7%E5%8F%96-TCP-%E9%93%BE%E6%8E%A5"><span class="top-box-text">3.3 获取 TCP 链接</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-%E8%8E%B7%E5%8F%96-TCP-%E5%89%8D%E5%A4%84%E7%90%86"><span class="top-box-text">1. 获取 TCP 前处理</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-%E5%B0%9D%E8%AF%95%E8%8E%B7%E5%8F%96-TCP-%E9%93%BE%E6%8E%A5"><span class="top-box-text">2. 尝试获取 TCP 链接</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-%E8%A2%AB%E5%8A%A8%E9%98%BB%E5%A1%9E-goroutine"><span class="top-box-text">3. 被动阻塞 goroutine</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#3-4-TCP-%E9%93%BE%E6%8E%A5%E8%AF%BB%E6%95%B0%E6%8D%AE"><span class="top-box-text">3.4 TCP 链接读数据</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-conn-fd-%E5%85%A5%E6%B1%A0"><span class="top-box-text">1. conn fd 入池</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-%E8%AF%BB-TCP-%E6%95%B0%E6%8D%AE"><span class="top-box-text">2. 读 TCP 数据</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-%E5%86%99-TCP-%E6%95%B0%E6%8D%AE"><span class="top-box-text">3. 写 TCP 数据</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#3-6-%E5%94%A4%E9%86%92-IO-%E9%98%BB%E5%A1%9E%E6%90%BA%E7%A8%8B"><span class="top-box-text">3.6 唤醒 IO 阻塞携程</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-%E5%85%A8%E5%B1%80%E7%9B%91%E6%8E%A7%E4%BB%BB%E5%8A%A1-sysmon"><span class="top-box-text">1. 全局监控任务 sysmon</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-GMP-%E8%B0%83%E5%BA%A6%E4%B8%BB%E6%B5%81%E7%A8%8B"><span class="top-box-text">2. GMP 调度主流程</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-GC-start-the-world"><span class="top-box-text">3. GC start the world</span></a></li></ol></li></ol></li></ol>
        </div>
          
      </div>
    </div>

    
      <div class="next-post">
        <a class="purple-link" href="/2024/01/22/Golang-HTTP-%E6%A0%87%E5%87%86%E5%BA%93%E5%AE%9E%E7%8E%B0/">
          <h3 class="post-title">
            下一篇：Golang HTTP 标准库实现
          </h3>
        </a>
      </div>
    
  </div>










<footer>
<div class="site-footer">
  <div class="social-container">
    
      
        <a aria-label="跳转至github" href="https://github.com/heexu976" target="_blank">
          <i class="icon icon-github"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
  </div>
  
  
  
  
  
  
</div>
</footer>


      </div>
    </div>
    
<script id="hexo-configurations"> window.theme_config = {"image":{"lazyload_enable":true,"photo_zoom":"simple-lightbox"}}; window.is_post = true; </script>

<script src="/js/main.js"></script>



    <script async src="https://hm.baidu.com/hm.js?b4e7880ffb5b09f08a8941a64e7d79f4"></script>




  </body>
</html>

